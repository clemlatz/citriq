<?php 

    include("../inc/functions.php");
    include("../inc/mysql.php");

    $reviews = mysql_query("
        SELECT `review_title`, `review_author`, `review_ean`, `review_publisher`, `review_shorturl`, `review_excerpt`, `review_reviewer`, `review_source`, `review_score`, `site_name`
        FROM `reviews`
        JOIN `sites` USING(`site_id`)
        WHERE `review_ean` = '".$_GET["ean"]."' AND `review_title` != '' ORDER BY `review_insert` DESC") or die(mysql_error());
    if($r = mysql_fetch_array($reviews)) { 

        $desc = 'Toutes les critiques pour '.$r["review_title"].' de '.$r["review_author"].' ('.$r["review_publisher"].')';
        while($rx = mysql_fetch_array($reviews)) {
            if(!empty($rx["review_excerpt"])) $desc = addslashes($rx["review_excerpt"]);
        }
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:og="http://ogp.me/ns#">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
        <meta http-equiv="Content-Style-Type" content="text/css" />
        <meta http-equiv="Content-Language" content="fr" />
        
        <link type="text/css" media="screen" rel="stylesheet" href="/css/styles.css" />
        <link href='http://fonts.googleapis.com/css?family=EB+Garamond' rel='stylesheet' type='text/css' />
        <link href='http://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css' />
        
        <link rel="alternate" type="application/rss+xml" title="Derni&egrave;res critiques pour <? echo $r["review_title"]; ?>" href="http://citriq.net/rss?q=<? echo $_GET["ean"]; ?>" />
        
        <title><? echo $r["review_title"]; ?> de <? echo $r["review_author"]; ?> | CITRIQ</title>
        
        <script type="text/javascript" src="http://apis.google.com/js/plusone.js">
            {lang: 'fr'}
        </script>
        
        <?php
            echo '
                <meta property="og:title" content="'.$r["review_title"].'" />
                <meta property="og:type" content="book" />
                <meta property="og:url" content="http://citriq.net/'.$r["review_ean"].'" />
                <meta property="og:description" content="'.$desc.'" />
                <meta property="og:site_name" content="CITRIQ" />
                <meta name="description" content="'.$desc.'" />
            ';
            if(filepath($r["review_ean"])) echo '<meta property="og:image" content="'.filepath($r["review_ean"],"url").'" />';
        ?>
        
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-1439349-21']);
            _gaq.push(['_trackPageview']);
            (function() {
              var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
              ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
              var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
    </head>
    <body id="book">
        <div id="page">
            <div id="header">
                <h1>CITRIQ</h1>
                <a href="/"><img src="/img/logo.png" alt="Citriq" /></a>
            </div>
            <div id="content">
                <?php
                    if(filepath($r["review_ean"])) $r["image"] = '<img src="'.filepath($r["review_ean"],"url").'" alt="'.$r["review_title"].'" />';
                    else $r["image"] = '';
                    
                    echo '
                        <div class="book-cover">
                            '.$r["image"].'
                        </div>
                        <div id="book-data">
                            <h2>'.$r["review_title"].'</h2>
                            <p class="book-author">Auteur : <a href="/?q='.$r["review_author"].'">'.$r["review_author"].'</a></p>
                            <p class="book-publisher">Editeur : <a href="/?q='.$r["review_publisher"].'">'.$r["review_publisher"].'</a></p>
                            <p class="book-isbn">ISBN : '.isbn($r["review_ean"],"ISBN").'</p>
                            <br />
                            <div id="book-buzz">
                                <a href="http://twitter.com/share" data-text="Toutes les critiques de '.$r["review_title"].' sur CITRIQ" class="twitter-share-button" data-count="horizontal" data-lang="fr">Tweeter</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
                                <g:plusone size="medium"></g:plusone>
                                <!-- a id="fb_share" name="fb_share" type="button_count" href="http://www.facebook.com/sharer.php">Partager</a><script src="http://static.ak.fbcdn.net/connect.php/js/FB.Share" type="text/javascript"></script -->
                                <iframe src="http://www.facebook.com/plugins/like.php?app_id=133975366679339&amp;href=http%3A%2F%2Fcitriq.net%2F'.$r["review_ean"].'&amp;send=false&amp;layout=button_count&amp;width=200&amp;show_faces=false&amp;action=recommend&amp;colorscheme=light&amp;font=lucida+grande&amp;height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:200px; height:21px;" allowTransparency="true"></iframe>
                            </div>
                        </div><script src="http://static.ak.fbcdn.net/connect.php/js/FB.Share" type="text/javascript"></script>
                    ';
                ?>
                <h3>Toutes les critiques</h3>
                <div id="reviews">
                    <?php
                        mysql_data_seek($reviews,0);
                        $other_reviews = '<br />';
                        while($r = mysql_fetch_array($reviews)) {
                            $score_img = ' &nbsp;';
                            if(!empty($r["review_score"])) {
                                $score = round($r["review_score"] / 20);
                                for($i = 0; $i < $score; $i++) $score_img .= '<img src="/img/icon_star_1.png" alt="note" />';
                                for($i = 5; $i > $score; $i--) $score_img .= '<img src="/img/icon_star_0.png" alt="note" />';
                            }
                            if(!empty($r["review_excerpt"])) {
                                if(!empty($r["review_source"]) and $r["review_source"] != $r["site_name"]) $r["site_name"] = '<a href="/'.$r["review_shorturl"].'">'.$r["review_source"].'</a>'; else $r["site_name"] = '<a href="/'.$r["review_shorturl"].'">'.$r["site_name"].'</a>';
                                if(!empty($r["review_reviewer"])) $reviewer = $r["review_reviewer"].' ('.$r["site_name"].')'; else $reviewer = $r["site_name"];
                                echo '<br /><p><span class="review_excerpt">&laquo;&nbsp;'.$r["review_excerpt"].'&nbsp;&raquo;</span><br />&#8594; '.$reviewer.'</a></p>';
                            }
                            else {
                                if(!empty($r["review_reviewer"])) $reviewer = ' de '.$r["review_reviewer"]; else $reviewer = NULL;
                                if(!empty($r["review_source"]) and $r["review_source"] != $r["site_name"]) $r["site_name"] = ' dans '.$r["review_source"]; else $r["site_name"] = ' sur '.$r["site_name"];
                                $other_reviews .= '<p><a href="/'.$r["review_shorturl"].'">Lire la critique '.$reviewer.$r["site_name"].' '.$score_img.'</a></p>';
                                //$other_reviews .= '<p><a href="/'.$r["review_shorturl"].'">Lire la critique de '.$r["site_name"].'</a></p>';
                            }
                        }
                        echo $other_reviews;
                    ?>
                </div>
            </div>
        </div>
    </body>
</html>

<?php

    } else header("Location: /?q=".$_GET["ean"]);

?>